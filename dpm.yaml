swagger: '2.0'
info:
  description: "Backend DPM"
  version: 1.0.1
  title: DPM API
  # put the contact info for your development or API team
  contact:
    email: ignaciofernandez@deengy.com

# tags are used for organizing operations
tags:
- name: substations
- name: relays
- name: oscillographies
- name: events
- name: settings
- name: reports
- name: panios
- name: instances
- name: backup

paths:

  /dpm/{instance_id}/substations/:
    get:
      tags:
      - substations
      summary: substations info
      description: |
        Get location and status of each substation in the instance.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      responses:
        200:
          description: Substations
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: integer
                  example: 924
                name:
                  type: string
                  example: Substation1
                lat: 
                  type: number
                  example: -241.42
                lon:
                  type: number
                  example: 92.32
                is_fail:
                  type: boolean
                  example: false
        401:
          description: Unauthorized. Bad authentication.
        403:
          description: Forbidden. No access to given instance_id.
    post:
      tags:
      - substations
      summary: create substation
      description: |
        Create a new substation in the instance. Caller has to be superadmin.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: body
        name: body
        schema:
          type: object
          properties:
            name:
              type: string
              example: Substation2
            lat:
              type: number
              example: -241.42
            lon:
              type: number
              example: 92.32
          
      responses:
        201:
          description: Created
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: integer
                  example: 924
                name:
                  type: string
                  example: Substation1
                lat: 
                  type: number
                  example: -241.42
                lon:
                  type: number
                  example: 92.32
        400:
          description: check 'detail' in response for error information
        401:
          description: Unauthorized. Bad authentication.
    
  /dpm/{instance_id}/substations/structure/:
    get:
      tags:
      - substations
      summary: substations structure
      description: |
        Get the structure of each substation->panio->relay 
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      responses:
        200:
          description: Substations
          schema:
            $ref: '#/definitions/SubstationStructure'
        401:
          description: Unauthorized. Bad authentication.
        403: 
          description: Forbidden. No access to the given instance_id.
          
  /dpm/{instance_id}/relays/:
    post:
      tags:
      - relays
      summary: create relay
      description: |
        Create relay in panio. Caller has to be superadmin.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: body
        name: body
        required: true
        schema:
          type: object
          properties:
            panio_id:
              type: integer
              example: 512
            mnemo:
              type: string
              example: mnemotecnico
            info:
              type: string
              example: infotecnica
            ip_address:
              type: string
              example: 192.168.1.20
            
      responses:
        201:
          description: Created
        400:
          description: Bad Request. Missing parameters
        403:
          description: Forbidden. No access to the given instance_id
          
    get:
      tags:
      - relays
      summary: get relays in panio
      description: |
        Get relays inn a given panio
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: query
        name: panio_id
        required: true
        type: integer
      responses:
        200:
          description: Relays
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: integer
                  example: 924
                info:
                  type: string
                  example: info
                mnemo:
                  type: string
                  example: mnemo
                ip_address:
                  type: string
                  example: 190.1.1.1
                panio:
                  type: string
                  example: panio1
                substation:
                  type: string
                  example: sub1
                is_reporter:
                  type: boolean
                  example: true
                is_fail:
                  type: boolean
                  example: false
                
        401:
          description: Unauthorized. Bad authentication.
        403:
          description: Forbidden. No access to given instance_id.
  
  /dpm/{instance_id}/relays/all/:
    get:
      tags:
      - relays
      summary: all relays in instance
      description: |
        Get relays all relays in an instance
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: query
        name: page
        required: true
        type: integer
        minimum: 0
      - in: query
        name: page_size
        required: true
        type: integer
        minimum: 0
        maximum: 50
      responses:
        200:
          description: Relays
          schema:
            type: object
            properties:
              total:
                type: integer
                example: 10
              data:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 90
                    mnemo:
                      type: string
                      example: mnemo
                    is_reporter:
                      type: boolean
                      example: true
                    panio:
                      type: string
                      example: panio1
                    substation:
                      type: string
                      example: sub1
              
                
        401:
          description: Unauthorized. Bad authentication.
        403:
          description: Forbidden. No access to given instance_id.
  
  /dpm/{instance_id}/relays/{relay_id}/:
    get:
      tags:
      - relays
      summary: relay info
      description: |
        Get information on a single relay.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      responses:
        200:
          description: Substations
          schema:
            type: object
            properties:
              id:
                type: integer
                example: 2134
              mnemo:
                type: string
                example: mnemotecnico
              info:
                type: string
                example: infotecnica
              ip_address:
                type: string
                example: 192.168.1.20
              panio:
                type: integer
                example: 512
              
        401:
          description: Unauthorized. Bad authentication.
        403: 
          description: Forbidden. No access to the given instance_id or relay.
          
  /dpm/{instance_id}/relays/{relay_id}/oscillographies/:
    get:
      tags:
      - oscillographies
      summary: get oscillographies
      description: |
        Get list of oscillographies in order.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: query
        name: page
        required: true
        type: integer
        minimum: 0
      - in: query
        name: page_size
        required: true
        type: integer
        minimum: 0
        maximum: 50
      - in: query
        type: string
        name: order_by
        required: false
        description: "order paramaters. Options are 'date' or '-date'. Default is '-date'"
      responses:
        200:
          description: oscillographies
          schema:
            type: object
            properties:
              total:
                type: integer
                example: 100
              data:
                type: array
                items:
                  type: object
                  properties:
                    id: 
                      type: integer
                      example: 580972
                    name:
                      type: string
                      example: "202102938,2990124020,pa91291274,t92407120"
                    relay:
                      type: integer
                      example: 823
                    date:
                      type: string
                      example: "2021-05-31T18:20:48.135307Z"
        400:
          description: bad request
        401:
          description: Unauthorized
        403:
          description: Forbidden
          
  
  /dpm/{instance_id}/relays/{relay_id}/oscillographies/{oscil_id}/:
    get:
      tags:
      - oscillographies
      summary: get oscillography info
      description: |
        Get list of oscillographies in order.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: path
        name: oscil_id
        required: true
        type: integer

      responses:
        200:
          description: oscillography
          schema:
            type: object
            properties:
              id: 
                type: integer
                example: 580972
              name:
                type: string
                example: "202102938,2990124020,pa91291274,t92407120"
              date:
                type: string
                example: "2021-05-31T18:20:48.135307Z"
              station_name:
                type: string
                example: Station1
              object_name:
                type: string
                example: BM1290AM
              start:  
                type: string
                example: "2021-05-31T18:20:48.135307Z"
              trigger:
                type: string
                example: "2021-05-31T18:20:48.135307Z"
              frequency:
                type: number
                example: 50
        401:
          description: Unauthorized
        403:
          description: Forbidden
          
  /dpm/{instance_id}/relays/{relay_id}/oscillographies/{oscil_id}/download/:
    get:
      tags:
      - oscillographies
      summary: download oscillography files
      description: |
        Download oscillography files as zip.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: path
        name: oscil_id
        required: true
        type: integer

      responses:
        200:
          description: oscillography link
          schema:
            type: object
            properties:
              link:
                type: string
                example: "https://s3.oscillography.com/123"
        401:
          description: Unauthorized
        403:
          description: Forbidden
    
  /dpm/{instance_id}/relays/{relay_id}/oscillographies/{oscil_id}/report/:
    get:
      tags:
      - oscillographies
      summary: oscillography plots
      description: |
        Oscillography plots
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: path
        name: oscil_id
        required: true
        type: integer

      responses:
        200:
          description: oscillography plot info (incomplete)
        401:
          description: Unauthorized
        403:
          description: Forbidden
          
  /dpm/oscillography_upload/{relay_id}/:
    post:
      tags:
      - oscillographies
      summary: upload oscillography
      description: |
        Upload a new oscillography as a zip file
      consumes:
      - multipart/form-data
      produces:
      - application/json
      parameters:
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: formData
        name: file
        description: zip file
        type: file
      
      responses:
        201:
          description: created
        400:
          description: bad request. check detail in response for error information
        404: 
          description: relay not found
          
  /dpm/{instance_id}/relays/{relay_id}/events/:
    get:
      tags:
      - events
      summary: relay events
      description: |
        Get relay events
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: query
        name: page
        required: true
        type: integer
        minimum: 0
      - in: query
        name: page_size
        required: true
        type: integer
        minimum: 0
        maximum: 50
      - in: query
        type: string
        name: order_by
        required: false
        description: "order paramaters. Options are ['date', 'description', 'date_created', 'alert']. Default is '-date'"
      responses:
        200:
          description: oscillographies
          schema:
            type: object
            properties:
              total:
                type: integer
                example: 100
              data:
                type: array
                items:
                  type: object
                  properties:
                    id: 
                      type: integer
                      example: 580972
                    description:
                      type: string
                      example: "NEW EVENT"
                    date:
                      type: string
                      example: "2021-05-31T18:20:48.135307Z"
                    date_created:
                      type: string
                      example: "2021-05-31T18:20:48.135307Z"
                    alert:
                      type: boolean
                      example: true
                    relay:
                      type: integer
                      example: 823
        400:
          description: bad request
        401:
          description: Unauthorized
        403:
          description: Forbidden
          
  /dpm/{instance_id}/relays/{relay_id}/settings/:
    get:
      tags:
      - settings
      summary: list relay settings
      description: |
        Get relay settings files
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: query
        name: page
        required: true
        type: integer
        minimum: 0
      - in: query
        name: page_size
        required: true
        type: integer
        minimum: 0
        maximum: 50
      - in: query
        type: string
        name: order_by
        required: false
        description: "order paramaters. Options are ['name', 'date', 'pk', 'alert']. Default is '-date'"
      responses:
        200:
          description: oscillographies
          schema:
            type: object
            properties:
              total:
                type: integer
                example: 100
              data:
                type: array
                items:
                  type: object
                  properties:
                    id: 
                      type: integer
                      example: 125
                    name:
                      type: string
                      example: setting.file
                    date:
                      type: string
                      example: "2021-05-31T18:20:48.135307Z"
        400:
          description: bad request
        401:
          description: Unauthorized
        403:
          description: Forbidden
    
    post:
      tags:
      - settings
      summary: upload relay settings
      description: |
        upload relay settings files. Callers has to be dpm admin.
      consumes:
      - multipart/form-data
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: formData
        name: file
        description: zip file
        type: file
      
      responses:
        201:
          description: created
        400:
          description: bad request. check detail in response for error information
        404: 
          description: relay not found
  
  /dpm/{instance_id}/relays/{relay_id}/settings/{setting_id}:
    get:
      tags:
      - settings
      summary: download setting
      description: |
        Get setting file download url (presigned url that only lasts 5 minutes)
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: path
        name: setting_id
        required: true
        type: integer
      responses:
        200:
          description: setting url
          schema:
            type: object
            properties:
              url:
                type: string
                example: https://amazon.com/archivo/123414214
        401:
          description: Unauthorized
        403:
          description: Forbidden
  
  /dpm/{instance_id}/relays/{relay_id}/reports/:
    get:
      tags:
      - reports
      summary: list relay reports
      description: |
        Get relay reports files
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: query
        name: page
        required: true
        type: integer
        minimum: 0
      - in: query
        name: page_size
        required: true
        type: integer
        minimum: 0
        maximum: 50
      - in: query
        type: string
        name: order_by
        required: false
        description: "order paramaters. Options are ['name', 'date', 'pk', 'alert']. Default is '-date'"
      responses:
        200:
          description: reports
          schema:
            type: object
            properties:
              total:
                type: integer
                example: 100
              data:
                type: array
                items:
                  type: object
                  properties:
                    id: 
                      type: integer
                      example: 125
                    name:
                      type: string
                      example: setting.file
        400:
          description: bad request
        401:
          description: Unauthorized
        403:
          description: Forbidden
    
    post:
      tags:
      - reports
      summary: upload relay reports
      description: |
        upload relay reports files. Callers has to be dpm admin.
      consumes:
      - multipart/form-data
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: formData
        name: file
        description: zip file
        type: file
      
      responses:
        201:
          description: created
        400:
          description: bad request. check detail in response for error information
        404: 
          description: relay not found
          
  /dpm/{instance_id}/relays/{relay_id}/reports/{report_id}:
    get:
      tags:
      - reports
      summary: download report
      description: |
        Get report download url (presigned url that only lasts 5 minutes)
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: path
        name: relay_id
        required: true
        type: integer
      - in: path
        name: report_id
        required: true
        type: integer
      responses:
        200:
          description: report url
          schema:
            type: object
            properties:
              url:
                type: string
                example: https://amazon.com/archivo/123414214
        401:
          description: Unauthorized
        403:
          description: Forbidden
          
  /dpm/{instance_id}/panios/:
    get:
      tags:
      - panios
      summary: get panios in substation
      description: |
        Get panios in substation
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: query
        name: substation_id
        required: true
        type: string
      responses:
        200:
          description: Panios
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: integer
                  example: 924
                name:
                  type: string
                  example: Substation1
                substation:
                  type: integer
                  example: 821
        401:
          description: Unauthorized. Bad authentication.
        403:
          description: Forbidden. No access to given instance_id.
    post:
      tags:
      - panios
      summary: create panio
      description: |
        Create a new panio in the substation. Caller has to be superadmin.
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: body
        name: body
        schema:
          type: object
          properties:
            name:
              type: string
              example: panio1
            substation_id:
              type: integer
              example: 982
          
      responses:
        201:
          description: Created
        400:
          description: check 'detail' in response for error information
        401:
          description: Unauthorized. Bad authentication.
          
  
  /dpm/instances/:
    post:
      tags:
      - instances
      summary: create instance
      description: |
        Create a new instance in DPM. Caller has to be superadmin.
      produces:
      - application/json
      parameters:
      - in: body
        name: body
        schema:
          type: object
          properties:
            name:
              type: string
              example: instance1
            instance_id:
              type: integer
              example: 982
          
      responses:
        201:
          description: Created
        400:
          description: check 'detail' in response for error information
        401:
          description: Unauthorized. Bad authentication.
          
  /dpm/{instance_id}/backup/:
    post:
      tags:
      - backup
      summary: ssh backup
      description: |
        Set up ssh information to backup an instance. Caller has to be superadmin.
      consumes:
      - multipart/form-data
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: formData
        name: file
        description: .pem file
        type: file
      - in: formData
        name: ssh_host
        type: string
      - in: formData
        name: username
        description: ssh username
        type: string
          
      responses:
        200:
          description: Ok
        400:
          description: check 'detail' in response for error information
        401:
          description: Unauthorized. Bad authentication.
  
  /dpm/{instance_id}/relays/activate_backup/:
    post:
      tags:
      - backup
      summary: activate backup
      description: |
        activate backup for a list of relays
      consumes:
      - multipart/form-data
      produces:
      - application/json
      parameters:
      - in: path
        name: instance_id
        required: true
        type: integer
      - in: body
        name: body
        schema:
          type: array
          items:
            type: integer
            example: 1
          
      responses:
        200:
          description: Ok
        400:
          description: check 'detail' in response for error information
        401:
          description: Unauthorized. Bad authentication.
  
definitions:
        
  SubstationStructure:
    type: array
    items:
      type: object
      properties:
        name:
          type: string
          example: Substation1
        panios:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: Panio1
              relays:
                type: array
                items:
                  type: object
                  properties:
                    mnemo:
                      type: string
                      example: ABC_123